info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      Initial configuration loaded from appsettings.json: 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLPCollectorService initialized for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.CollectorBackgroundService[0]
      DLP Collector Service started
info: DLP.RiskAnalyzer.Collector.Services.CollectorBackgroundService[0]
      Starting incident collection from Forcepoint DLP REST API v1...
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\Users\syadm55576\Desktop\dlp-risk-adaptive-protection-csharp-main\DLP.RiskAnalyzer.Collector
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      Access token obtained successfully, expires at 12/11/2025 11:28:26
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (initial load): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpConfigurationSyncService[0]
      Subscribed to DLP config updates via Redis channel dlp:config:updated
fail: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      Failed to fetch incidents from Forcepoint DLP API
      System.Threading.Tasks.TaskCanceledException: The operation was canceled.
       ---> System.IO.IOException: Unable to read data from the transport connection: The I/O operation has been aborted because of either a thread exit or an application request..
       ---> System.Net.Sockets.SocketException (995): The I/O operation has been aborted because of either a thread exit or an application request.
         --- End of inner exception stack trace ---
         at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.ThrowException(SocketError error, CancellationToken cancellationToken)
         at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.System.Threading.Tasks.Sources.IValueTaskSource<System.Int32>.GetResult(Int16 token)
         at System.Net.Security.SslStream.EnsureFullTlsFrameAsync[TIOAdapter](CancellationToken cancellationToken, Int32 estimatedSize)
         at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
         at System.Net.Security.SslStream.ReadAsyncInternal[TIOAdapter](Memory`1 buffer, CancellationToken cancellationToken)
         at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
         at System.Net.Http.HttpConnection.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         --- End of inner exception stack trace ---
         at System.Net.Http.HttpConnection.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         at System.Net.Http.HttpConnectionPool.SendWithVersionDetectionAndRetryAsync(HttpRequestMessage request, Boolean async, Boolean doRequestAuth, CancellationToken cancellationToken)
         at System.Net.Http.RedirectHandler.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at DLP.RiskAnalyzer.Collector.Services.DLPCollectorService.FetchIncidentsAsync(DateTime startTime, DateTime endTime, Int32 page, Int32 pageSize) in C:\Users\syadm55576\Desktop\dlp-risk-adaptive-protection-csharp-main\DLP.RiskAnalyzer.Collector\Services\DLPCollectorService.cs:line 176
warn: DLP.RiskAnalyzer.Collector.Services.CollectorBackgroundService[0]
      DLP API request timeout. Will retry on next interval.
      System.Threading.Tasks.TaskCanceledException: The operation was canceled.
       ---> System.IO.IOException: Unable to read data from the transport connection: The I/O operation has been aborted because of either a thread exit or an application request..
       ---> System.Net.Sockets.SocketException (995): The I/O operation has been aborted because of either a thread exit or an application request.
         --- End of inner exception stack trace ---
         at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.ThrowException(SocketError error, CancellationToken cancellationToken)
         at System.Net.Sockets.Socket.AwaitableSocketAsyncEventArgs.System.Threading.Tasks.Sources.IValueTaskSource<System.Int32>.GetResult(Int16 token)
         at System.Net.Security.SslStream.EnsureFullTlsFrameAsync[TIOAdapter](CancellationToken cancellationToken, Int32 estimatedSize)
         at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
         at System.Net.Security.SslStream.ReadAsyncInternal[TIOAdapter](Memory`1 buffer, CancellationToken cancellationToken)
         at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
         at System.Net.Http.HttpConnection.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         --- End of inner exception stack trace ---
         at System.Net.Http.HttpConnection.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         at System.Net.Http.HttpConnectionPool.SendWithVersionDetectionAndRetryAsync(HttpRequestMessage request, Boolean async, Boolean doRequestAuth, CancellationToken cancellationToken)
         at System.Net.Http.RedirectHandler.SendAsync(HttpRequestMessage request, Boolean async, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at DLP.RiskAnalyzer.Collector.Services.DLPCollectorService.FetchIncidentsAsync(DateTime startTime, DateTime endTime, Int32 page, Int32 pageSize) in C:\Users\syadm55576\Desktop\dlp-risk-adaptive-protection-csharp-main\DLP.RiskAnalyzer.Collector\Services\DLPCollectorService.cs:line 176
         at DLP.RiskAnalyzer.Collector.Services.CollectorBackgroundService.CollectIncidentsAsync(CancellationToken cancellationToken) in C:\Users\syadm55576\Desktop\dlp-risk-adaptive-protection-csharp-main\DLP.RiskAnalyzer.Collector\Services\CollectorBackgroundService.cs:line 96
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Redis broadcast: 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443
info: DLP.RiskAnalyzer.Collector.Services.DlpRuntimeConfigProvider[0]
      DLP configuration updated via Analyzer API (scheduled poll): 172.16.245.126::9443, HTTPS=True, Timeout=300s, Username=apiuser
info: DLP.RiskAnalyzer.Collector.Services.DLPCollectorService[0]
      DLP Collector HTTP client reconfigured for 172.16.245.126:9443



# 1. Önce token al
$headers = @{
    "username" = "apiuser"
    "password" = "SIFRENI_YAZ"
}

$tokenResponse = Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/auth/access-token" -Method Post -Headers $headers -SkipCertificateCheck

Write-Host "Token: $($tokenResponse.access_token)"





# 2. Token'ı kullanarak incident çek (küçük limit ile)
$token = "YUKARIDAKI_TOKEN"

$body = @{
    type = "INCIDENTS"
    from_date = "11/12/2025 10:00:00"
    to_date = "11/12/2025 12:00:00"
    start = 0
    limit = 10
} | ConvertTo-Json

$incidentHeaders = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/incidents/" -Method Post -Headers $incidentHeaders -Body $body -SkipCertificateCheck -TimeoutSec 120


Invoke-RestMethod : A parameter cannot be found that matches parameter name 'SkipCertificateCheck'.
At line:7 char:132
+ ... th/access-token" -Method Post -Headers $headers -SkipCertificateCheck
+                                                     ~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidArgument: (:) [Invoke-RestMethod], ParameterBindingException
    + FullyQualifiedErrorId : NamedParameterNotFound,Microsoft.PowerShell.Commands.InvokeRestMethodCommand


# SSL sertifika kontrolünü devre dışı bırak (PowerShell 5.1 için)
add-type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint srvPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# 1. Token al
$headers = @{
    "username" = "apiuser"
    "password" = "SIFRENI_YAZ"
}

$tokenResponse = Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/auth/access-token" -Method Post -Headers $headers

Write-Host "Token: $($tokenResponse.access_token)"




# 2. Incident çek
$token = "YUKARIDAKI_TOKEN"

$body = @{
    type = "INCIDENTS"
    from_date = "11/12/2025 10:00:00"
    to_date = "11/12/2025 12:00:00"
    start = 0
    limit = 10
} | ConvertTo-Json

$incidentHeaders = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/incidents/" -Method Post -Headers $incidentHeaders -Body $body -TimeoutSec 120


Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/incidents/" -Method Post -Headers $incidentHeaders -Body $body -TimeoutSec 120
Invoke-RestMethod : Specified value has invalid CRLF characters.
Parameter name: value
At line:18 char:1
+ Invoke-RestMethod -Uri "https://172.16.245.126:9443/dlp/rest/v1/incid ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [Invoke-RestMethod], ArgumentException
    + FullyQualifiedErrorId : System.ArgumentException,Microsoft.PowerShell.Commands.InvokeRestMethodCommand
